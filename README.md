# dominate - 汽车哨兵安防系统

## 项目简介
dominate 是一套基于多传感器融合与远程通信技术的汽车哨兵安防系统，集成**多传感器数据采集、视频监控、异常检测、云端数据处理、用户交互**五大核心能力，实现对车辆周边环境的实时监控、异常事件触发报警及远程视频查看，为车辆安全提供智能化防护。


## 一、硬件组成
### 1.1 核心硬件选型
| 硬件模块         | 型号/规格                  | 功能用途                          |
|------------------|---------------------------|-----------------------------------|
| 主核心板         | Samsung Exynos FS4412     | 负责摄像头数据采集、编码、存储与传输 |
| 数据采集芯片     | STM32F103C8T6             | 采集传感器数据并封装协议          |
| 超声波传感器     | HC-SR04                   | 测量车辆周边物体距离              |
| 人体红外传感器   | HC-SR501                  | 检测车辆周边人体活动              |
| 震动传感器       | SW-420                    | 监测车辆震动异常                  |
| 通信模块         | 5G USB网卡                | 提供核心板网络连接（依赖USB驱动） |
| 外设             | 摄像头、蜂鸣器、LED、SD卡 | 视频采集、异常报警、本地存储      |

### 1.2 硬件连接
- **拓扑图**：采用分层连接架构，STM32 与核心板通过串口通信，传感器接入 STM32，5G 模块、摄像头、SD 卡直接接入核心板。
- **实际连接示例**：核心板通过 USB 接口连接 5G 网卡与摄像头，STM32 通过 USB 转 TTL 与核心板通信，传感器（HC-SR04/HC-SR501/SW-420）通过 GPIO 接入 STM32。


## 二、软件架构
系统采用“端-云-边”三层架构，分为 **STM32 数据采集层、核心板边缘计算层、云端服务层、UI 交互层**，各层通过 MQTT 协议实现数据交互。

### 2.1 模块拆解
#### 2.1.1 STM32 数据采集模块
- **功能**：实时采集传感器数据，进行滤波、异常检测与协议封装后，通过串口发送至核心板。
- **帧格式**（统一通信协议）：
  | 字段         | 字节数 | 说明                              | 示例值       |
  |--------------|--------|-----------------------------------|--------------|
  | 帧头         | 2      | 数据帧起始标识                    | 0xAA 0x55    |
  | 功能码       | 1      | 数据类型（如超声波=0x03）         | 0x03         |
  | 数据长度     | 1      | 数据区字节数                      | 0x02         |
  | 数据         | N      | 传感器原始数据（如距离）          | 0x007B（123cm） |
  | CRC 校验     | 2      | CRC16-IBM 校验（覆盖功能码+数据） | 0xC4 0x1B    |
- **传感器接口**：人体红外（PB5）、震动（PB4）、超声波（Trig=PB0，Echo=PB6）。

#### 2.1.2 核心板模块
- **系统移植**：完成 BSP 搭建、操作系统裁剪与移植，优化 BootLoader、内核及文件系统；配置 GPIO/UART/SPI/I²C/PWM 外设。
- **驱动开发**：
  - 蜂鸣器/LED：基于 Platform 驱动框架，通过设备树匹配，提供 `/dev/my_leds`/`/dev/pwm_beep` 节点控制。
  - 5G 模块：依赖 USB 驱动、USB 转以太网驱动、USB 转串口驱动（支持 AT 命令）。
  - 摄像头/SD 卡：免驱模块，支持视频采集与循环存储（双 MP4 文件轮转）。
- **应用功能**：
  - 传感器数据接收：解析 STM32 串口数据，CRC 校验后判断异常。
  - 视频处理：通过 FFmpeg 库实现视频录制、分段存储与 MP4 封装。
  - 异常上报：触发异常后，上报“异常前历史视频+异常中视频”至云端。
  - 实时响应：订阅 MQTT 实时视频请求，推送视频帧至 UI 端。

#### 2.1.3 云端数据服务器
- **核心组件**：
  1. **MQTT 服务**（Mosquitto  broker）：
     - 作用：实现消息中转，解耦发布者（核心板/UI）与订阅者（云端）。
     - 关键 Topic 列表：
       | 业务场景         | 操作类型 | Topic 路径                          |
       |------------------|----------|------------------------------------|
       | 异常视频上报     | 订阅     | $sys/{pid}/thing/err_video/post    |
       | 异常视频列表请求 | 订阅     | $sys/{pid}/thing/err_list/post     |
       | 异常视频列表回复 | 发布     | $sys/{pid}/thing/err_list/post/reply |
       | 异常视频下发请求 | 订阅     | $sys/{pid}/thing/err_video/get     |
       | 异常视频下发回复 | 发布     | $sys/{pid}/thing/err_video/get/reply |
       | 用户登录/注册    | 订阅     | $sys/thing/login/post              |
       | 用户登录/注册回复| 发布     | $sys/{pid}/thing/login/post/reply  |
       | 实时视频请求     | 订阅     | $sys/{did}/thing/video/post        |
       | 实时视频回复     | 发布     | $sys/{did}/thing/video/post/reply  |
  2. **MySQL 数据库**：
     - 设备列表库：存储已出厂设备唯一 ID（device_id）。
     - 用户列表库：存储用户信息（device_id、user_name、password、log_dir、video_dir），注册时自动创建日志/视频目录。
  3. **日志系统**：
     - 分类：用户日志（独立目录，按等级区分）、系统日志。
     - 格式：`[时间][等级]：日志正文`（示例：`[2025-08-24 13:33:45][SYSTEM]: 开始订阅所有设备的相关Topic...`）。

#### 2.1.4 UI 客户端（Qt 框架）
- **界面组成**：
  1. 登录界面：输入用户名、密码、设备 ID（device_id），通过 MQTT 与云端交互验证。
  2. 注册界面：录入用户信息，校验设备 ID 合法性（匹配云端设备库）。
  3. 主界面：
     - 天气与日期：调用和风天气 API（HTTPS）获取实时天气。
     - 实时视频模块：发送 MQTT 请求，接收核心板推送的视频帧。
     - 异常视频模块：请求异常视频列表，通过云端临时 HTTP 服务访问视频文件。


## 三、核心功能
1. **多传感器异常检测**：通过人体红外、震动、超声波传感器联动，识别车辆周边异常活动（如人员靠近、车辆震动）。
2. **视频监控与存储**：
   - 本地循环存储：摄像头视频以双 MP4 文件轮转存储于 SD 卡。
   - 云端异常备份：异常事件触发后，自动上报视频至云端并封装为 MP4。
3. **远程交互**：用户通过 UI 客户端远程登录，查看实时视频、异常视频列表及历史记录。
4. **异常报警**：本地通过蜂鸣器+LED 触发声光报警，远程通过 UI 推送异常通知。
5. **用户管理**：支持用户注册（设备 ID 绑定）、登录校验，数据存储于云端 MySQL。


## 四、部署说明
### 4.1 硬件部署
1. 按拓扑图连接传感器与 STM32，STM32 通过 USB 转 TTL 接入核心板。
2. 核心板连接 5G 网卡、摄像头、SD 卡，确保外设供电正常。

### 4.2 云端部署
1. 安装 Mosquitto MQTT 服务器，配置 broker 服务端口。
2. 安装 MySQL，创建设备库与用户库，执行安全配置（如 `mysql_secure_installation`）。
3. 部署 MQTT 客户端，订阅关键 Topic，配置视频合并（FFmpeg）与 HTTP 临时服务逻辑。

### 4.3 UI 客户端部署
1. 基于 Qt 框架编译客户端代码，确保与云端 MQTT 服务器网络互通。
2. 配置和风天气 API 密钥，确保天气数据正常拉取。


## 五、待优化方向
1. **UI 功能完善**：增加用户密码修改、账号删除功能；登录/注册环节添加验证码校验，提升安全性。
2. **数据传输加密**：当前 MQTT 通信为明文，需新增 TLS/SSL 加密，保护用户信息与视频数据。
3. **远程控制扩展**：增加用户手动控制车辆功能（如远程鸣笛、灯光控制），增强交互性。


## 六、贡献与许可证
- **贡献方式**：欢迎提交 Issue 反馈问题，或通过 Pull Request 提交代码优化（建议先同步需求至项目维护者）。
- **许可证**：本项目采用 MIT 许可证，允许非商业与商业用途，修改后需保留原版权声明。
